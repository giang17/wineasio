# WineASIO GitHub Actions Build Workflow
# Builds WineASIO for Wine 11+ on Ubuntu

name: Build WineASIO

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y \
          gcc-mingw-w64-x86-64 \
          gcc-mingw-w64-i686 \
          gcc-multilib \
          libjack-jackd2-dev \
          libjack-jackd2-dev:i386 \
          wine-stable \
          wine-stable-dev \
          python3-pyqt5

    - name: Build 64-bit
      run: make -f Makefile.wine11 64

    - name: Build 32-bit
      run: make -f Makefile.wine11 32

    - name: Build GUI launchers
      run: |
        cd gui
        make || true
        cd ..

    - name: List build artifacts
      run: |
        echo "=== Build directory ==="
        ls -la build_wine11/
        echo "=== GUI directory ==="
        ls -la gui/ || true

    - name: Upload 64-bit artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wineasio-64bit
        path: |
          build_wine11/wineasio64.dll
          build_wine11/wineasio64.so

    - name: Upload 32-bit artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wineasio-32bit
        path: |
          build_wine11/wineasio.dll
          build_wine11/wineasio.so

    - name: Upload GUI artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wineasio-gui
        path: |
          gui/wineasio-settings
          gui/settings.py
          gui/ui_settings.py
          gui/wineasio-settings.exe
          gui/wineasio-settings64.exe
        if-no-files-found: warn

  package:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create release package
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        PACKAGE_NAME="wineasio-${VERSION}"

        # Create binary package structure
        mkdir -p "${PACKAGE_NAME}/64bit"
        mkdir -p "${PACKAGE_NAME}/32bit"
        mkdir -p "${PACKAGE_NAME}/gui"

        # Copy binaries
        cp artifacts/wineasio-64bit/* "${PACKAGE_NAME}/64bit/" || true
        cp artifacts/wineasio-32bit/* "${PACKAGE_NAME}/32bit/" || true
        cp artifacts/wineasio-gui/* "${PACKAGE_NAME}/gui/" || true

        # Copy documentation
        cp README.md "${PACKAGE_NAME}/"
        cp RELEASE_NOTES.md "${PACKAGE_NAME}/" || true
        cp COPYING.LIB "${PACKAGE_NAME}/"
        cp COPYING.GUI "${PACKAGE_NAME}/"

        # Create tarball
        tar -czvf "${PACKAGE_NAME}-binaries.tar.gz" "${PACKAGE_NAME}"

        # Create source tarball
        git archive --format=tar.gz --prefix="${PACKAGE_NAME}-source/" -o "${PACKAGE_NAME}-source.tar.gz" HEAD

        # Create checksums
        sha256sum *.tar.gz > SHA256SUMS.txt

    - name: Upload release packages
      uses: actions/upload-artifact@v4
      with:
        name: release-packages
        path: |
          *.tar.gz
          SHA256SUMS.txt

  release:
    runs-on: ubuntu-latest
    needs: package
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - name: Download release packages
      uses: actions/download-artifact@v4
      with:
        name: release-packages

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.tar.gz
          SHA256SUMS.txt
        body: |
          # WineASIO ${{ github.ref_name }} üç∑üéµ

          ## What's New

          See RELEASE_NOTES.md for full details.

          ## Downloads

          | File | Description |
          |------|-------------|
          | `wineasio-*-source.tar.gz` | Complete source code |
          | `wineasio-*-binaries.tar.gz` | Pre-built binaries |

          ## Quick Install

          ```bash
          tar -xzf wineasio-*-binaries.tar.gz
          cd wineasio-*/
          sudo cp 64bit/* /opt/wine-stable/lib/wine/x86_64-{windows,unix}/
          sudo cp 32bit/* /opt/wine-stable/lib/wine/i386-{windows,unix}/
          wine regsvr32 wineasio64.dll
          ```

          ## Requirements

          - Wine 10.2+ or Wine 11
          - JACK Audio Connection Kit
          - PyQt5 or PyQt6 (for settings GUI)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
